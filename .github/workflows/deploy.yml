name: Deploy .NET Application

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.x'
    
    - name: Set version
      shell: pwsh
      run: |
        $projectFile = Get-ChildItem -Recurse -Filter *.csproj | Select-Object -First 1

        $csprojXml = [Xml](Get-Content $projectFile.FullName)
        $csprojVersion = [System.Version]$csprojXml.Project.PropertyGroup.Version
        $newVersion = [System.Version]::new($csprojVersion.Major, 0, ${{ github.run_number }})

    # Testing if vars persist if I put it in a pwsh shell
    - name: Build
      shell: pwsh
      run: | 
        $newVersion
        dotnet build --configuration Release /p:Version=$newVersion
      
    - name: Publish
      shell: pwsh
      run: | 
        $newVersion
        dotnet publish --configuration Release /p:Version=$newVersion
    

# Things to try:
# ( ) Test the zip code (the path stuff. aka do vars persist between actions?)
# ( ) RDP into the github runner